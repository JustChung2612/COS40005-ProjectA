import "./patientCaseDetailPage.scss";
import { useEffect, useMemo, useRef, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";
// import axios from "axios";
// import { toast } from "react-hot-toast";
import {
  ArrowLeft,
  Loader2,
  AlertCircle,
  PlusCircle,
  Trash2,
} from "lucide-react";

// import TramThi1 from "../../data/TramThi1.js";
import TramThi1 from "../../../../Data/dummy-data/TramThi1";

/* ========= UI PRIMITIVES (local, giống Stations) ========= */
export const Card = ({ className = "", children, ...p }) => (
  <div className={["card", className].join(" ")} {...p}>
    {children}
  </div>
);

export const CardContent = ({ className = "", children, ...p }) => (
  <div className={["card__content", className].join(" ")} {...p}>
    {children}
  </div>
);

/* ========= Hằng số ========= */
const QUESTION_TYPES = [
  { value: "radio", label: "Trắc nghiệm (1 đáp án đúng)" },
  { value: "checkbox", label: "Trắc nghiệm (nhiều đáp án đúng)" },
  { value: "text", label: "Câu trả lời ngắn" },
];

const createEmptyQuestion = (index) => ({
  id: `new-${Date.now()}-${index}`,
  noi_dung: "",
  kieu: "radio",
  lua_chon: ["Tùy chọn 1", "Tùy chọn 2"],
  // lưu index các đáp án đúng
  dap_an_dung: [],
  diem: 1,
  bat_buoc: false,
});

const normalizeQuestionsFromCase = (caseData) => {
  const raw = caseData?.cau_hoi;
  if (!Array.isArray(raw) || raw.length === 0) return [];

  return raw.map((q, idx) => ({
    id: q.id ?? `q-${idx + 1}`,
    noi_dung: q.noi_dung || "",
    kieu: q.kieu || "radio",
    lua_chon:
      Array.isArray(q.lua_chon) && q.lua_chon.length > 0
        ? q.lua_chon
        : ["Tùy chọn 1"],
    // nếu có dap_an_dung dạng text thì map về index, còn không thì để trống
    dap_an_dung: Array.isArray(q.dap_an_dung)
      ? q.dap_an_dung
          .map((ansText) =>
            Array.isArray(q.lua_chon) ? q.lua_chon.indexOf(ansText) : -1
          )
          .filter((i) => i >= 0)
      : [],
    diem: typeof q.diem === "number" ? q.diem : 1,
    bat_buoc: Boolean(q.bat_buoc),
  }));
};

/* ========= Component chính ========= */
const PatientCaseDetailPage = () => {
  const { id } = useParams();
  const navigate = useNavigate();

  const [caseData, setCaseData] = useState(null);
  const [questions, setQuestions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [activeSection, setActiveSection] = useState("thong_tin");

  // refs để scroll tới từng phần bệnh án
  const thongTinRef = useRef(null);
  const benhSuRef = useRef(null);
  const tienCanRef = useRef(null);
  const luocQuaRef = useRef(null);
  const khamLSRef = useRef(null);

  const scrollToSection = (ref, key) => {
    setActiveSection(key);
    ref?.current?.scrollIntoView({ behavior: "smooth", block: "start" });
  };

  /* ====== Kết nối backend (tạm thời khóa lại) ====== */
  // useEffect(() => {
  //   const fetchCase = async () => {
  //     try {
  //       setLoading(true);
  //       const res = await axios.get(`http://localhost:5000/api/patient-cases/${id}`);
  //       setCaseData(res.data?.data);
  //     } catch (err) {
  //       console.error("Lỗi khi tải bệnh án:", err);
  //       setError("Không thể tải thông tin bệnh án.");
  //       toast.error("Không thể tải thông tin bệnh án.");
  //     } finally {
  //       setLoading(false);
  //     }
  //   };
  //   fetchCase();
  // }, [id]);

  /* ====== Tạm thời dùng dữ liệu mock từ TramThi1 ====== */
  useEffect(() => {
    setLoading(true);
    try {
      setCaseData(TramThi1);
      setError(null);
    } catch (err) {
      console.error("Lỗi khi tải bệnh án từ TramThi1:", err);
      setError("Không thể tải thông tin bệnh án (mock).");
    } finally {
      setLoading(false);
    }
  }, [id]);

  // Khi caseData có dữ liệu, chuẩn hóa câu hỏi cho chế độ soạn đề
  useEffect(() => {
    if (!caseData) {
      setQuestions([]);
      return;
    }
    const normalized = normalizeQuestionsFromCase(caseData);
    setQuestions(normalized.length > 0 ? normalized : [createEmptyQuestion(1)]);
  }, [caseData]);

  const totalPoints = useMemo(
    () => questions.reduce((sum, q) => sum + (Number(q.diem) || 0), 0),
    [questions]
  );

  const updateQuestion = (index, partial) => {
    setQuestions((prev) =>
      prev.map((q, i) => (i === index ? { ...q, ...partial } : q))
    );
  };

  const handleAddQuestion = () => {
    setQuestions((prev) => [...prev, createEmptyQuestion(prev.length + 1)]);
  };

  const handleDeleteQuestion = (index) => {
    setQuestions((prev) => prev.filter((_, i) => i !== index));
  };

  const handleDuplicateQuestion = (index) => {
    setQuestions((prev) => {
      const q = prev[index];
      const clone = {
        ...q,
        id: `${q.id || index + 1}-copy-${Date.now()}`,
        noi_dung: q.noi_dung ? `${q.noi_dung} (bản sao)` : "",
      };
      const next = [...prev];
      next.splice(index + 1, 0, clone);
      return next;
    });
  };

  const handleAddOption = (qIndex) => {
    setQuestions((prev) =>
      prev.map((q, i) =>
        i === qIndex
          ? {
              ...q,
              lua_chon: [
                ...(q.lua_chon || []),
                `Tùy chọn ${q.lua_chon.length + 1}`,
              ],
            }
          : q
      )
    );
  };

  const handleRemoveOption = (qIndex, optIndex) => {
    setQuestions((prev) =>
      prev.map((q, i) => {
        if (i !== qIndex) return q;
        const newOptions = (q.lua_chon || []).filter(
          (_, idx) => idx !== optIndex
        );
        const newCorrect = (q.dap_an_dung || [])
          .filter((idx) => idx !== optIndex)
          .map((idx) => (idx > optIndex ? idx - 1 : idx));
        return { ...q, lua_chon: newOptions, dap_an_dung: newCorrect };
      })
    );
  };

  const handleChangeCorrect = (qIndex, optIndex, isCheckbox) => {
    setQuestions((prev) =>
      prev.map((q, i) => {
        if (i !== qIndex) return q;
        const current = q.dap_an_dung || [];
        if (isCheckbox) {
          const exists = current.includes(optIndex);
          const next = exists
            ? current.filter((idx) => idx !== optIndex)
            : [...current, optIndex];
          return { ...q, dap_an_dung: next };
        }
        // radio
        return { ...q, dap_an_dung: [optIndex] };
      })
    );
  };

  if (loading) {
    return (
      <div className="caseDetail__loading">
        <Loader2 className="spin" size={30} /> Đang tải bệnh án...
      </div>
    );
  }

  if (error) {
    return <div className="caseDetail__error">{error}</div>;
  }

  if (!caseData) {
    return <div className="caseDetail__error">Không tìm thấy bệnh án.</div>;
  }

  const metadata = caseData.metadata || {};
  const benhAn = caseData.benh_an_tinh_huong || caseData.benh_an || {};
  const patient =
    benhAn.thong_tin_benh_nhan || caseData.thong_tin_benh_nhan || {};

  return (
    <div className="patientCaseDetail-page">
      {/* Header */}
      <div className="caseDetail-top">
        <button className="backBtn" onClick={() => navigate(-1)}>
          <ArrowLeft /> Quay lại
        </button>

        <div className="caseDetail-top__main">
          <h1 className="caseDetail__title">
            {metadata.chuan_doan || "Bệnh án tình huống"}
          </h1>
          <p className="caseDetail__subtitle">
            Cơ quan: {metadata.co_quan || "Chưa rõ"} · Độ khó:{" "}
            {metadata.do_kho || "Chưa rõ"}
          </p>
        </div>

        <div className="caseDetail-top__meta">
          <div className="meta-row">
            <span className="meta-label">Số câu hỏi</span>
            <span className="meta-value">{questions.length}</span>
          </div>
          <div className="meta-row">
            <span className="meta-label">Tổng điểm</span>
            <span className="meta-value">{totalPoints}</span>
          </div>
        </div>
      </div>

      {/* Main split layout */}
      <div className="caseDetail-main">
        {/* Bên trái: Bệnh án + TOC */}
        <aside className="left">
          <nav className="toc">
            <div className="toc__title">Bệnh Án</div>
            <button
              className={[
                "toc__item",
                activeSection === "thong_tin" ? "is-active" : "",
              ].join(" ")}
              onClick={() => scrollToSection(thongTinRef, "thong_tin")}
            >
              Thông tin bệnh nhân
            </button>
            <button
              className={[
                "toc__item",
                activeSection === "benh_su" ? "is-active" : "",
              ].join(" ")}
              onClick={() => scrollToSection(benhSuRef, "benh_su")}
            >
              Bệnh sử
            </button>
            <button
              className={[
                "toc__item",
                activeSection === "tien_can" ? "is-active" : "",
              ].join(" ")}
              onClick={() => scrollToSection(tienCanRef, "tien_can")}
            >
              Tiền căn
            </button>
            <button
              className={[
                "toc__item",
                activeSection === "luoc_qua" ? "is-active" : "",
              ].join(" ")}
              onClick={() => scrollToSection(luocQuaRef, "luoc_qua")}
            >
              Lược qua các cơ quan
            </button>
            <button
              className={[
                "toc__item",
                activeSection === "kham" ? "is-active" : "",
              ].join(" ")}
              onClick={() => scrollToSection(khamLSRef, "kham")}
            >
              Khám lâm sàng
            </button>
          </nav>

          <div className="case">
            <Card className="mb">
              <CardContent>
                <section ref={thongTinRef} className="section">
                  <h2 className="section__title">Thông tin bệnh nhân</h2>
                  <ul className="list">
                    <li>
                      <b>Họ tên:</b> {patient.ho_ten}
                    </li>
                    <li>
                      <b>Tuổi:</b> {patient.tuoi}
                    </li>
                    <li>
                      <b>Giới tính:</b> {patient.gioi_tinh}
                    </li>
                    <li>
                      <b>Nghề nghiệp:</b> {patient.nghe_nghiep}
                    </li>
                    <li>
                      <b>Lý do nhập viện:</b> {patient.ly_do_nhap_vien}
                    </li>
                  </ul>
                </section>

                <section ref={benhSuRef} className="section">
                  <h3 className="section__title">Bệnh sử</h3>
                  <div className="paras">
                    {benhAn.benh_su?.mo_ta1 && <p>{benhAn.benh_su.mo_ta1}</p>}
                    {benhAn.benh_su?.mo_ta2 && <p>{benhAn.benh_su.mo_ta2}</p>}
                    {benhAn.benh_su?.mo_ta3 && <p>{benhAn.benh_su.mo_ta3}</p>}
                  </div>
                </section>

                <section ref={tienCanRef} className="section">
                  <h3 className="section__title">Tiền căn</h3>
                  <ul className="list">
                    {(benhAn.tien_can || []).map((t, i) => (
                      <li key={i}>{t}</li>
                    ))}
                  </ul>
                </section>

                <section ref={luocQuaRef} className="section">
                  <h3 className="section__title">Lược qua các cơ quan</h3>
                  <ul className="list">
                    {(benhAn.luoc_qua_cac_co_quan || []).map((t, i) => (
                      <li key={i}>{t}</li>
                    ))}
                  </ul>
                </section>

                <section ref={khamLSRef} className="section">
                  <h3 className="section__title">Khám lâm sàng</h3>
                  <ul className="list">
                    {(benhAn.kham_lam_sang || []).map((t, i) => (
                      <li key={i}>{t}</li>
                    ))}
                  </ul>
                </section>
              </CardContent>
            </Card>

            <div className="note">
              <div className="note__head">
                <AlertCircle className="ico primary" />
                <span>Ghi chú</span>
              </div>
              <p>
                Đọc kỹ bệnh án trước khi soạn câu hỏi. Cố gắng bao quát đủ thông tin
                quan trọng trong từng câu.
              </p>
            </div>
          </div>
        </aside>

        {/* Bên phải: khu GIẢNG VIÊN SOẠN CÂU HỎI */}
        <section className="right">
          <div className="qbuilder">
            <div className="qbuilder__header">
              <div>
                <h2 className="qbuilder__title">Soạn câu hỏi</h2>
                <p className="qbuilder__subtitle">
                  Dựa trên bệnh án bên trái, hãy tạo danh sách câu hỏi trắc nghiệm / tự
                  luận.
                </p>
              </div>

              <button
                className="btn btn--primary"
                type="button"
                onClick={handleAddQuestion}
              >
                <PlusCircle size={18} />
                <span>Thêm câu hỏi</span>
              </button>
            </div>

            <div className="qbuilder__summary">
              <span>
                <b>{questions.length}</b> câu hỏi
              </span>
              <span>
                Tổng điểm: <b>{totalPoints}</b>
              </span>
            </div>

            <div className="qbuilder__list">
              {questions.map((q, index) => (
                <Card key={q.id || index} className="qbuilder__item">
                  <CardContent>
                    <div className="qbuilder__row qbuilder__row--top">
                      <input
                        className="qbuilder__question-input"
                        type="text"
                        placeholder={`Câu hỏi ${index + 1} (nhập nội dung câu hỏi)`}
                        value={q.noi_dung}
                        onChange={(e) =>
                          updateQuestion(index, { noi_dung: e.target.value })
                        }
                      />

                      <select
                        className="qbuilder__type-select"
                        value={q.kieu}
                        onChange={(e) =>
                          updateQuestion(index, { kieu: e.target.value })
                        }
                      >
                        {QUESTION_TYPES.map((t) => (
                          <option key={t.value} value={t.value}>
                            {t.label}
                          </option>
                        ))}
                      </select>
                    </div>

                    {/* Options cho câu hỏi trắc nghiệm */}
                    {q.kieu === "radio" || q.kieu === "checkbox" ? (
                      <div className="qbuilder__options">
                        {(q.lua_chon || []).map((opt, optIndex) => {
                          const isCheckbox = q.kieu === "checkbox";
                          const checked =
                            Array.isArray(q.dap_an_dung) &&
                            q.dap_an_dung.includes(optIndex);

                          return (
                            <div className="qbuilder__option-row" key={optIndex}>
                              <input
                                type={isCheckbox ? "checkbox" : "radio"}
                                name={`correct-${q.id}`}
                                className="qbuilder__option-correct"
                                checked={checked}
                                onChange={() =>
                                  handleChangeCorrect(index, optIndex, isCheckbox)
                                }
                              />

                              <input
                                className="qbuilder__option-input"
                                type="text"
                                placeholder={`Tùy chọn ${optIndex + 1}`}
                                value={opt}
                                onChange={(e) => {
                                  const nextOpts = [...(q.lua_chon || [])];
                                  nextOpts[optIndex] = e.target.value;
                                  updateQuestion(index, { lua_chon: nextOpts });
                                }}
                              />

                              <button
                                type="button"
                                className="qbuilder__option-remove"
                                onClick={() => handleRemoveOption(index, optIndex)}
                              >
                                <Trash2 size={16} />
                              </button>
                            </div>
                          );
                        })}

                        <button
                          type="button"
                          className="qbuilder__add-option"
                          onClick={() => handleAddOption(index)}
                        >
                          Thêm tùy chọn
                        </button>
                      </div>
                    ) : null}

                    {/* Câu trả lời dạng text */}
                    {q.kieu === "text" && (
                      <div className="qbuilder__text-preview">
                        <input
                          className="qbuilder__text-input"
                          type="text"
                          disabled
                          placeholder="Ô trả lời ngắn của sinh viên (preview)"
                        />
                      </div>
                    )}

                    <div className="qbuilder__footer">
                      <div className="qbuilder__score">
                        <span>Điểm:</span>
                        <input
                          type="number"
                          min={0}
                          className="qbuilder__score-input"
                          value={q.diem}
                          onChange={(e) =>
                            updateQuestion(index, {
                              diem: Number(e.target.value) || 0,
                            })
                          }
                        />
                      </div>

                      <label className="qbuilder__required">
                        <input
                          type="checkbox"
                          checked={q.bat_buoc}
                          onChange={(e) =>
                            updateQuestion(index, { bat_buoc: e.target.checked })
                          }
                        />
                        <span>Bắt buộc</span>
                      </label>

                      <div className="qbuilder__actions">
                        <button
                          type="button"
                          className="btn btn--ghost dublicate"
                          onClick={() => handleDuplicateQuestion(index)}
                        >
                          Nhân bản
                        </button>
                        <button
                          type="button"
                          className="btn btn--ghost delete"
                          onClick={() => handleDeleteQuestion(index)}
                        >
                          Xóa câu hỏi
                        </button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
        </section>
      </div>
    </div>
  );
};

export default PatientCaseDetailPage;
